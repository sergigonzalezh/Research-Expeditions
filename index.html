<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Expedition Globe — Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    #globeViz { width:100%; height:100vh; display:block; }
    .popup {
      background: rgba(255,255,255,0.95);
      border-radius:6px;
      padding:10px;
      max-width:260px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      font-size:13px;
    }
    .popup img { width:100%; height:auto; border-radius:4px; margin-bottom:6px; }
    .legend { position: absolute; left: 12px; top: 12px; z-index:2; background:rgba(255,255,255,0.9); padding:8px 10px; border-radius:8px; font-size:13px; }
  </style>
</head>
<body>
  <div id="globeViz"></div>
  <div class="legend">Click markers for expedition info • Use mouse to rotate/zoom</div>

  <!-- three.js + globe.gl from CDN -->
  <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/globe.gl"></script>

  <script>
  // Example data inline. Replace with fetch('/expeditions.json') if you host a separate file.
  const DATA = {
    points: [
      { id:'exp1', name:'Antarctic Traverse 2023', lat:-75.25, lng:-0.071, date:'2023-12-10', short:'Zero-emission Windsled traverse. Photos & notes.', image:'https://placekitten.com/800/400', url:'#' },
      { id:'exp2', name:'Greenland Fieldwork 2024', lat:72.0, lng:-40.0, date:'2024-07-05', short:'Snow/meteorological AWS sites.', image:'https://placekitten.com/801/400', url:'#' },
      { id:'exp3', name:'Alpine Campaign 2022', lat:42.35, lng:2.2, date:'2022-09-01', short:'High-mountain snow pits and sensors', image:'https://placekitten.com/802/400', url:'#' }
    ],
    routes: [
      { id:'r1', coords:[[-0.071,-75.25],[-20,-60],[-40,72.0]] } // [lng,lat] pairs - note we will convert if necessary
    ]
  };

  // Convert points to globe-friendly format
  const markers = DATA.points.map(p => ({
    lat: p.lat,
    lng: p.lng,
    name: p.name,
    id: p.id,
    short: p.short,
    date: p.date,
    image: p.image,
    url: p.url
  }));

  // Helper to build simple HTML popup
  function makePopupHtml(d) {
    return `
      <div class="popup">
        ${d.image ? `<img src="${d.image}" alt="${d.name}">` : ''}
        <strong>${d.name}</strong><br/>
        <small>${d.date}</small>
        <p style="margin:6px 0 0 0">${d.short || ''}</p>
        ${d.url ? `<p style="margin:6px 0 0 0"><a href="${d.url}" target="_blank" rel="noopener">Read more</a></p>` : ''}
      </div>`;
  }

  // Create the globe
  const world = Globe()
    (document.getElementById('globeViz'))
    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg') // nice night texture
    .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png') // subtle topography
    .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
    .showAtmosphere(true)
    .pointOfView({ lat: 20, lng: 10, altitude: 2.5 }, 0) // initial camera
    .controls() // allow drag/zoom
    ;

  // Add markers (as small 3D sprites)
  world
    .pointsData(markers)
    .pointLat('lat')
    .pointLng('lng')
    .pointAltitude(0.01)
    .pointColor(() => '#ffcc00')
    .pointLabel('name')
    .pointRadius(0.4)
    .onPointClick((d) => {
      // show popup anchored at the top-left of the page (simple)
      const content = makePopupHtml(d);
      // remove old popup if any
      const existing = document.getElementById('globePopup');
      if (existing) existing.remove();
      const popup = document.createElement('div');
      popup.id = 'globePopup';
      popup.style.position = 'absolute';
      popup.style.right = '12px';
      popup.style.bottom = '12px';
      popup.innerHTML = content;
      document.body.appendChild(popup);
    });

  // Add routes as arcs (convert to lat/lng order)
  world
    .arcsData(DATA.routes.map(r => ({
      startLat: r.coords[0][1], startLng: r.coords[0][0],
      endLat: r.coords[r.coords.length-1][1], endLng: r.coords[r.coords.length-1][0],
      color: ['rgba(0,200,255,0.8)']
    })))
    .arcColor('color')
    .arcAltitudeAutoScale(true)
    .arcStroke(1)
    .arcLabel(d => `Route`)
    .arcsTransitionDuration(1000);

  // Optionally: fly to a marker
  function flyToPoint(id) {
    const p = markers.find(m => m.id === id);
    if (!p) return;
    world.pointOfView({ lat: p.lat, lng: p.lng, altitude: 1.2 }, 1500);
  }

  // Example: fly to first point after 1s
  setTimeout(()=>flyToPoint(markers[0].id), 1200);

  // Clean up popup on click outside
  document.addEventListener('click', (ev)=> {
    const existing = document.getElementById('globePopup');
    if (existing && !ev.target.closest('.popup')) existing.remove();
  });

  </script>
</body>
</html>
